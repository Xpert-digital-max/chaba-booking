<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å - ‡∏ä‡∏ö‡∏≤‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ï</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body { font-family: sans-serif; background-color: #f3f4f6; margin: 0; padding-bottom: 50px; }
        .container { max-width: 450px; margin: 0 auto; background: white; min-height: 100vh; position: relative; }
        .header { height: 200px; background-color: #333; position: relative; overflow: hidden; }
        .header img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .header-text { position: absolute; bottom: 20px; left: 20px; color: white; text-shadow: 1px 1px 4px rgba(0,0,0,0.5); }
        .content { padding: 20px; border-radius: 20px 20px 0 0; background: white; margin-top: -20px; position: relative; }
        .form-group { margin-bottom: 15px; }
        .label { display: block; font-weight: bold; margin-bottom: 5px; color: #374151; }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 15px; background-color: #10B981; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn:disabled { background-color: #ccc; }
        .room-item { border: 2px solid #eee; border-radius: 10px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; cursor: pointer; }
        .room-item.selected { border-color: #10B981; background-color: #ecfdf5; }
        .room-img { width: 80px; height: 80px; background-color: #ddd; border-radius: 5px; object-fit: cover; margin-right: 15px; }
        .hidden { display: none; }
        .loading { text-align: center; color: #666; margin-top: 20px; }
        /* Admin Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; items-center; z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 10px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&q=80&w=1000">
        <div class="header-text">
            <h1 style="margin:0; font-size:24px;">Chaba Resort</h1>
            <p style="margin:5px 0 0 0;">üìç ‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ</p>
        </div>
        <button onclick="toggleAdmin()" style="position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.3); border:none; border-radius:50%; padding:8px; cursor:pointer;">‚öôÔ∏è</button>
    </div>

    <div class="content">
        <div id="profileSection" style="display:flex; align-items:center; margin-bottom:20px; background:#f0fdf4; padding:10px; border-radius:10px;">
            <img id="userImg" src="https://via.placeholder.com/50" style="width:40px; height:40px; border-radius:50%; margin-right:10px;">
            <div>
                <div style="font-size:12px; color:#10B981;">‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ô‡∏≤‡∏°</div>
                <div id="userName" style="font-weight:bold;">Guest</div>
            </div>
        </div>

        <div class="form-group">
            <label class="label">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</label>
            <div style="display:flex; gap:10px;">
                <input type="date" id="checkIn" class="input-box" onchange="updateCheckOut()">
                <input type="date" id="checkOut" class="input-box" disabled>
            </div>
        </div>

        <div class="form-group">
            <div style="display:flex; justify-content:space-between;">
                <label class="label">üè° ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</label>
                <a href="#" onclick="fetchRooms(); return false;" style="color:#10B981; font-size:12px;">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</a>
            </div>
            <div id="roomList">
                <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å...</div>
            </div>
            <input type="hidden" id="selectedRoom">
        </div>

        <div class="form-group">
            <label class="label">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
            <input type="tel" id="phone" class="input-box" placeholder="08x-xxx-xxxx">
        </div>

        <button id="submitBtn" class="btn" onclick="submitBooking()" disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô</button>
    </div>
</div>

<div id="adminModal" class="hidden modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3 style="margin:0;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</h3>
            <button onclick="toggleAdmin()" style="border:none; background:none; font-size:20px;">&times;</button>
        </div>
        <div id="adminList"></div>
        <div style="margin-top:20px; padding-top:20px; border-top:1px solid #eee;">
            <h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h4>
            <input id="newRoomName" class="input-box" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á" style="margin-bottom:10px;">
            <input id="newRoomPrice" class="input-box" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" style="margin-bottom:10px;">
            <input id="newRoomDesc" class="input-box" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" style="margin-bottom:10px;">
            <label style="font-size:12px;">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</label>
            <input type="file" id="newRoomFile" style="margin-bottom:10px;">
            <button class="btn" onclick="addRoom()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</button>
        </div>
    </div>
</div>

<script>
    // ‚ñº‚ñº‚ñº ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ñº‚ñº‚ñº
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxU_Z-oGVJxLwBFCP4nb-C2ZzLS3gg0CAVXXdmGoQlF2OWCWcqbIIlULzkOVEauJBy0/exec"; 
    const LIFF_ID = "2009043114-Ndo88F4L";

    let rooms = [];
    let userProfile = { userId: 'Guest', displayName: 'Guest', pictureUrl: '' };

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    window.onload = function() {
        initLiff();
        fetchRooms();
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('checkIn').min = today;
    };

    async function initLiff() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                userProfile = profile;
                document.getElementById('userName').innerText = profile.displayName;
                if(profile.pictureUrl) document.getElementById('userImg').src = profile.pictureUrl;
            } else {
                // liff.login();
            }
        } catch (err) {
            console.log('LIFF Error:', err);
        }
    }

    function fetchRooms() {
        document.getElementById('roomList').innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
        
        // ‡πÉ‡∏ä‡πâ POST ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Cache
        fetch(WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'get_rooms' })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                rooms = result.data;
                renderRooms();
            } else {
                alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message);
            }
        })
        .catch(error => {
            document.getElementById('roomList').innerHTML = '<div style="color:red; text-align:center;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß<br>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Deploy ‡πÄ‡∏õ‡πá‡∏ô Anyone ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</div>';
        });
    }

    function renderRooms() {
        const list = document.getElementById('roomList');
        list.innerHTML = '';
        if (rooms.length === 0) {
            list.innerHTML = '<div class="loading">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</div>';
            return;
        }
        
        rooms.forEach(room => {
            const div = document.createElement('div');
            div.className = 'room-item';
            div.onclick = () => selectRoom(room.name, div);
            div.innerHTML = `
                <img src="${room.image || 'https://via.placeholder.com/150'}" class="room-img">
                <div style="flex:1;">
                    <div style="font-weight:bold;">${room.name}</div>
                    <div style="font-size:12px; color:#666;">${room.desc || '-'}</div>
                    <div style="color:#10B981; font-weight:bold;">‡∏ø${room.price}</div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function selectRoom(name, element) {
        document.getElementById('selectedRoom').value = name;
        document.querySelectorAll('.room-item').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        checkForm();
    }

    function updateCheckOut() {
        const checkIn = document.getElementById('checkIn').value;
        const checkOutInput = document.getElementById('checkOut');
        
        if (checkIn) {
            const date = new Date(checkIn);
            date.setDate(date.getDate() + 1);
            const minDate = date.toISOString().split('T')[0];
            checkOutInput.min = minDate;
            checkOutInput.value = ''; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤
            checkOutInput.disabled = false;
        }
        checkForm();
    }

    function checkForm() {
        const room = document.getElementById('selectedRoom').value;
        const checkIn = document.getElementById('checkIn').value;
        const checkOut = document.getElementById('checkOut').value;
        const btn = document.getElementById('submitBtn');
        
        if (room && checkIn && checkOut) {
            btn.disabled = false;
            btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
        } else {
            btn.disabled = true;
            btn.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö";
        }
    }

    function submitBooking() {
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

        const payload = {
            action: 'booking',
            checkIn: document.getElementById('checkIn').value,
            checkOut: document.getElementById('checkOut').value,
            roomType: document.getElementById('selectedRoom').value,
            phone: document.getElementById('phone').value,
            lineUserId: userProfile.userId,
            lineDisplayName: userProfile.displayName,
            linePictureUrl: userProfile.pictureUrl
        };

        // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö no-cors (Fire & Forget) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏ß‡∏£‡πå
        fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            alert("‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! \n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏≤‡∏á LINE");
            liff.closeWindow();
        }).catch(err => {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err);
            btn.disabled = false;
            btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
        });
    }

    // --- Admin Logic ---
    function toggleAdmin() {
        const modal = document.getElementById('adminModal');
        modal.classList.toggle('hidden');
        if (!modal.classList.contains('hidden')) {
            renderAdminList();
        }
    }

    function renderAdminList() {
        const list = document.getElementById('adminList');
        list.innerHTML = '';
        rooms.forEach(room => {
            list.innerHTML += `
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                    <span>${room.name}</span>
                    <button onclick="deleteRoom('${room.id}')" style="color:red; border:none; background:none;">‡∏•‡∏ö</button>
                </div>
            `;
        });
    }

    function addRoom() {
        const name = document.getElementById('newRoomName').value;
        const price = document.getElementById('newRoomPrice').value;
        const desc = document.getElementById('newRoomDesc').value;
        const fileInput = document.getElementById('newRoomFile');

        if (!name || !price) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤');
            return;
        }

        const roomData = { id: Date.now(), name, price, desc, image: '' };
        
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ
        if (fileInput.files.length > 0) {
            const reader = new FileReader();
            reader.onload = function(e) {
                roomData.imageBase64 = e.target.result;
                sendRoomData(roomData);
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            sendRoomData(roomData);
        }
    }

    function sendRoomData(data) {
        alert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)");
        fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'save_room', room: data })
        }).then(() => {
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!");
            toggleAdmin();
            // ‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
            setTimeout(fetchRooms, 2000); 
        });
    }

    function deleteRoom(id) {
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?")) return;
        fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'delete_room', roomId: id })
        }).then(() => {
            alert("‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
            toggleAdmin();
            setTimeout(fetchRooms, 1000);
        });
    }
</script>

</body>
</html>